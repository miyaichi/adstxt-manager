files:
  "/opt/elasticbeanstalk/hooks/appdeploy/pre/50npm.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/bash
      
      # npmのメモリ制限を増やす
      export NODE_OPTIONS="--max-old-space-size=3072"
      
      # npmビルドプロセスのタイムアウトを延長
      echo "Setting NPM timeout to 600 seconds"
      mkdir -p /root/.npm
      echo "timeout=600000" >> /root/.npmrc
      
      # スワップ領域の作成（メモリ不足対策）
      if [ ! -f /swapfile ]; then
        echo "Creating swap space..."
        dd if=/dev/zero of=/swapfile bs=1M count=4096
        chmod 600 /swapfile
        mkswap /swapfile
        swapon /swapfile
        echo "/swapfile swap swap defaults 0 0" >> /etc/fstab
      fi
      
  "/opt/elasticbeanstalk/hooks/appdeploy/post/99_optimize_memory.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/bash
      
      # デプロイ後にキャッシュやログファイルを削除してメモリを解放
      echo "Cleaning up to optimize memory usage..."
      
      # npmキャッシュをクリア
      npm cache clean --force
      
      # 一時ファイルを削除
      rm -rf /tmp/npm-*
      rm -rf /tmp/v8-*
      
      # キャッシュディレクトリを削除
      rm -rf ~/.npm
      
      echo "Memory optimization complete"