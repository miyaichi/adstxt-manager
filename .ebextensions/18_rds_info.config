files:
  "/tmp/check_rds.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/bash
      
      echo "RDS Database Information:"
      echo "-----------------------"
      
      # Get RDS hostname from environment variable
      RDS_HOSTNAME=$(printenv PGHOST || echo "Not set")
      RDS_PORT=$(printenv PGPORT || echo "Not set")
      RDS_NAME=$(printenv PGDATABASE || echo "Not set")
      RDS_USER=$(printenv PGUSER || echo "Not set")
      
      echo "PGHOST: $RDS_HOSTNAME"
      echo "PGPORT: $RDS_PORT"
      echo "PGDATABASE: $RDS_NAME"
      echo "PGUSER: $RDS_USER"
      
      # Check connectivity
      echo "-----------------------"
      echo "Testing connection to PostgreSQL database..."
      
      # Try alternate values if needed
      if [[ "$RDS_HOSTNAME" == "Not set" ]]; then
        RDS_HOSTNAME="awseb-e-vb3bggm9qp-stack-awsebrdsdatabase-eblwi87ocxx0.cwtgd8gpsmhu.ap-northeast-1.rds.amazonaws.com"
        echo "Using alternate hostname: $RDS_HOSTNAME"
      fi
      
      if [[ "$RDS_PORT" == "Not set" ]]; then
        RDS_PORT="5432"
        echo "Using default port: $RDS_PORT"
      fi
      
      # Test connectivity with pg_isready
      if command -v pg_isready &> /dev/null; then
        pg_isready -h $RDS_HOSTNAME -p $RDS_PORT
        if [ $? -eq 0 ]; then
          echo "Connection successful!"
        else
          echo "Connection failed using pg_isready"
        fi
      else
        echo "pg_isready not available"
      fi
      
      # Try a direct telnet connection
      echo "-----------------------"
      echo "Testing TCP connection with timeout..."
      timeout 5 bash -c "echo > /dev/tcp/$RDS_HOSTNAME/$RDS_PORT" 2>/dev/null
      if [ $? -eq 0 ]; then
        echo "TCP connection successful"
      else
        echo "TCP connection failed"
      fi
      
      # Output to a log file
      echo "-----------------------"
      echo "Diagnostic information saved to /var/log/rds_diagnostics.log"
      
container_commands:
  01_run_rds_check:
    command: |
      /tmp/check_rds.sh > /var/log/rds_diagnostics.log 2>&1