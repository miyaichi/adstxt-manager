files:
  "/tmp/db_migration.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/bash
      
      cd /var/app/current/backend
      
      # Wait for RDS to be available
      echo "Waiting for database to be available..."
      for i in {1..30}; do
        npx wait-on tcp:$PGHOST:$PGPORT && break
        echo "Waiting for database connection ($i/30)..."
        sleep 10
      done
      
      # Run migrations
      echo "Running database migrations..."
      cd src/db/migrations
      node run.js
      
      echo "Database migration completed"

container_commands:
  01_run_migrations:
    command: "/tmp/db_migration.sh"
    leader_only: true