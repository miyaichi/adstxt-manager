files:
  "/opt/elasticbeanstalk/hooks/appdeploy/pre/99_fix_db_connection.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/bash
      
      echo "Creating database fix script..."
      
      # Get RDS connection info from EBS environment
      RDS_HOSTNAME=$(printenv PGHOST || echo "localhost")
      RDS_PORT=$(printenv PGPORT || echo "5432")
      
      # Create the .env file with manually specified values
      cat > /tmp/db.env << EOL
DB_PROVIDER=postgres
PGHOST=${RDS_HOSTNAME}
PGPORT=5432
PGDATABASE=adstxt_manager
PGUSER=dbadmin
PGPASSWORD=H4kKfRTKGBwkCAyM
PG_MAX_POOL_SIZE=10
NODE_ENV=production
PORT=8080
EOL
      
      echo "Created database environment file:"
      cat /tmp/db.env
      
      # Move the file to the proper location when app is deployed
      mkdir -p /var/app/staging/backend
      cp /tmp/db.env /var/app/staging/backend/.env
      
      echo "Database fix script complete"
  
  "/opt/elasticbeanstalk/hooks/appdeploy/post/99_check_db_connection.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/bash
      
      echo "Checking database connection..."
      
      # Display current environment variables for debugging
      echo "Current environment variables:"
      env | grep -i pg
      
      # Display the .env file contents
      echo "Contents of .env file:"
      cat /var/app/current/backend/.env
      
      echo "Checking database connection complete"