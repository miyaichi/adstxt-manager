Resources:
  AdsManagerDB:
    Type: AWS::RDS::DBInstance
    Properties:
      AllocatedStorage: 20
      DBInstanceClass: db.t3.micro
      DBName: adstxt_manager
      Engine: postgres
      EngineVersion: 14.7
      MasterUsername: dbadmin
      MasterUserPassword: 
        "Ref": "DBPassword"
      MultiAZ: false
      StorageType: gp2
      Tags:
        - Key: Name
          Value: AdsManagerDB
    DeletionPolicy: Snapshot

  DBSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: RDS Security Group
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 5432
          ToPort: 5432
          SourceSecurityGroupId: 
            "Fn::GetAtt": ["AWSEBSecurityGroup", "GroupId"]

Parameters:
  DBPassword:
    NoEcho: true
    Description: The database admin account password
    Type: String
    MinLength: 8
    MaxLength: 40
    AllowedPattern: "[a-zA-Z0-9]*"
    ConstraintDescription: must contain only alphanumeric characters.

option_settings:
  aws:elasticbeanstalk:application:environment:
    PGHOST: 
      "Fn::GetAtt": ["AdsManagerDB", "Endpoint.Address"]
    PGPORT: 
      "Fn::GetAtt": ["AdsManagerDB", "Endpoint.Port"]
    PGDATABASE: adstxt_manager
    PGUSER: dbadmin
    PGPASSWORD: 
      "Ref": "DBPassword"